<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/rooctblog/blog/rss.xml" title="Develop Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rooctblog/blog/atom.xml" title="Develop Site Blog Atom Feed"><title data-react-helmet="true">RandomDAO事件及其分析 | Develop Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://rooct.github.io/rooctblog/docs/dapps/Event/RandomDAO"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="RandomDAO事件及其分析 | Develop Site"><meta data-react-helmet="true" name="description" content="事件概要"><meta data-react-helmet="true" property="og:description" content="事件概要"><link data-react-helmet="true" rel="shortcut icon" href="/rooctblog/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://rooct.github.io/rooctblog/docs/dapps/Event/RandomDAO"><link data-react-helmet="true" rel="alternate" href="https://rooct.github.io/rooctblog/docs/dapps/Event/RandomDAO" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://rooct.github.io/rooctblog/docs/dapps/Event/RandomDAO" hreflang="x-default"><link rel="stylesheet" href="/rooctblog/assets/css/styles.63c342b0.css">
<link rel="preload" href="/rooctblog/assets/js/runtime~main.cf7fc36f.js" as="script">
<link rel="preload" href="/rooctblog/assets/js/main.998fc8e4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rooctblog/"><img src="/rooctblog/img/logo.svg" alt="Dev Site Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/rooctblog/img/logo.svg" alt="Dev Site Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Dev Site</b></a><a class="navbar__item navbar__link" href="/rooctblog/docs/intro">Solidity</a><a class="navbar__item navbar__link" href="/rooctblog/docs/evm">EVM</a><a class="navbar__item navbar__link navbar__link--active" href="/rooctblog/docs/dapp">Dapps</a><a class="navbar__item navbar__link" href="/rooctblog/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Dapps</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rooctblog/docs/dapp">smartcontract</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">DEX</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Event</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rooctblog/docs/dapps/Event/EIP1559_GAS">EIP1559下的 GAS 费设置解析</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rooctblog/docs/dapps/Event/OnChainMessageProtocol">链上通信协议，到底有什么用？</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rooctblog/docs/dapps/Event/README">智能合约事件分析</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rooctblog/docs/dapps/Event/RandomDAO">RandomDAO事件及其分析</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rooctblog/docs/dapps/Event/X2Y2_DecentralizedOrderReward">X2Y2: 必须修改的中心化NFT挂单奖励机制</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Example</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">GunPool</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Loan</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">NFT</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Robot</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Solidity</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">StableCoin</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RandomDAO事件及其分析</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="事件概要"></a>事件概要<a class="hash-link" href="#事件概要" title="Direct link to heading">#</a></h2><p>2022年2月4日，12岁中国深圳小学生黄振（网传名）在 <a href="https://space.bilibili.com/516216318" target="_blank" rel="noopener noreferrer">B站</a> 和 <a href="https://twitter.com/therandomdao" target="_blank" rel="noopener noreferrer">twitter</a> 上发布了自己的solidity教学视频，发布了自己的教学项目 <a href="http://therandomdao.com/" target="_blank" rel="noopener noreferrer">RandomDAO</a>。随着一些大V的转发，这个项目引起了币民们的注意。直到2022年2月8日，已经有超过47000个地址领取了他发布的空投代币 <a href="https://etherscan.io/token/0x1c7E83f8C581a967940DBfa7984744646AE46b29" target="_blank" rel="noopener noreferrer">RND</a>，并曾达到ETH消耗gas费排行第二。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="事件分析"></a>事件分析<a class="hash-link" href="#事件分析" title="Direct link to heading">#</a></h2><p>由于这是一个偏向技术的社群，因此我一般只关注技术方面的特点。黄振同学（暂且先这么称呼着）发布的 Random 合约只是一个普通的 ERC20 合约加一个空投逻辑，本来是不值得开篇文章说的。但是区块链网络上出现了一个随之而生的突变：<a href="https://github.com/33357/airdrop_multi_claim" target="_blank" rel="noopener noreferrer">https://github.com/33357/airdrop_multi_claim</a> 这个合约实现了对 Random 合约空投的批量获取，并借此获取了大量收益 <a href="https://etherscan.io/tx/0xfc1d5688c18244764fe3678020b4821a8c215c7a7f42685814b3cf49557967ff" target="_blank" rel="noopener noreferrer">https://etherscan.io/tx/0xfc1d5688c18244764fe3678020b4821a8c215c7a7f42685814b3cf49557967ff</a>（保守估计30多个ETH）, 这就非常值得我来好好研究一下它的实现逻辑了。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="合约分析"></a>合约分析<a class="hash-link" href="#合约分析" title="Direct link to heading">#</a></h2><ul><li><p>操作原理</p><p>  我们看到 <a href="https://etherscan.io/address/0x1c7E83f8C581a967940DBfa7984744646AE46b29#code" target="_blank" rel="noopener noreferrer">https://etherscan.io/address/0x1c7E83f8C581a967940DBfa7984744646AE46b29#code</a> 上的获取空投函数是这样写的</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    function claim() external{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if( (uint32(block.timestamp)-release_time) &lt;= 360 days &amp;&amp; is_claim[msg.sender] == false ){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            is_claim[msg.sender] = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            yet_claim_people.push(msg.sender);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _mint(msg.sender,return_claim_number());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  这里对<code>claim</code>函数的检查只有两个：</p><ul><li><code>(uint32(block.timestamp)-release_time) &lt;= 360 days</code>，领取空投的时间需要在合约发布之后的360天之内。</li><li><code>is_claim[msg.sender] == false</code>，领取过的地址不能再领取。
但是这里并没有拒绝合约的调用。也就是说，使用合约地址进行claim是完全可以的，这就为接下来的操作提供了基础。</li></ul></li><li><p>批量创建合约实现批量领取空投</p><ul><li><p>multi_claim_with_selfdestruct.txt</p><p>  在 <a href="https://github.com/33357/airdrop_multi_claim/blob/main/contracts/multi_claim_with_selfdestruct.txt" target="_blank" rel="noopener noreferrer">multi_claim_with_selfdestruct.txt</a> 文件中，可以看到主方法<code>call</code>的实现</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">uint256 times</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uint i</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">times</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">claimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  这里通过<code>for</code>循环实现了批量创建合约<code>claimer</code>。</p><p>  接下来看<code>claimer</code>合约的实现</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">contract claimer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">claim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">balanceOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">selfdestruct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">payable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  在<code>claimer</code>合约初始化函数<code>constructor</code>中，调用了<code>airdrop</code>合约的<code>claim</code>方法，而<code>airdrop</code>合约就是上面提到的<code>RND</code>代币空投合约。在获取<code>RND</code>代币的空投之后，<code>claimer</code>合约会将<code>RND</code>代币转给调用链发起人<code>tx.origin</code>，最后调用<code>selfdestruct</code>自毁合约。（这里自毁合约的逻辑没有搞清楚，据说自毁合约可以返还gas费，不知真假）
</p></li><li><p>multi_claim.sol</p><p>  在<a href="https://github.com/33357/airdrop_multi_claim/blob/main/contracts/multi_claim.sol" target="_blank" rel="noopener noreferrer">multi_claim.sol</a> 文件中，可以看到它的实现逻辑和 <code>multi_claim_with_selfdestruct.txt</code> 是一样的，但是多了一个额外的函数 <code>addressto</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addressto</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address _origin</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> uint256 _nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> internal pure </span><span class="token function" style="color:#d73a49">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address _address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes memory data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">          data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xd6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xd6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xd7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x81</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xd8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x82</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xd9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain">                        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodePacked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xda</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x94</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bytes1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x84</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nonce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes32 hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keccak256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    assembly </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">mstore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">_address</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  据我所知，这个函数实现了对部署下一个合约地址的预测，在<code>claimer</code>合约当中</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">contract claimer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address selfAdd</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> address receiver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        address contra </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xbb2A2D70d6a4B80FA2C4d4Ca43a8525da430196c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">claim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">balanceOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selfAdd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;Oh no&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">airdrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">receiver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  在<code>uint256 balance = airdrop(contra).balanceOf(selfAdd)</code>中，<code>selfAdd</code>是预测出来的合约合约地址，所以这里能获取正确的<code>balance</code>。这个<code>claimer</code>合约移除了<code>selfdestruct</code>函数。</p></li><li><p>疑问</p><p>  在<code>README.md</code>文件中，说 <code>multi_claim合约实现了高效撸（一次交易claim多次）没有EOA机制的合约</code> 对此我没有能够完全理解，特别是做地址预测的目的和 <code>selfdestruct</code> 的使用，希望有知道的大佬们告诉一下，好填完这个坑。</p></li></ul></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rooctblog/docs/dapps/Event/README"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 智能合约事件分析</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rooctblog/docs/dapps/Event/X2Y2_DecentralizedOrderReward"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">X2Y2: 必须修改的中心化NFT挂单奖励机制 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#事件概要" class="table-of-contents__link">事件概要</a></li><li><a href="#事件分析" class="table-of-contents__link">事件分析</a></li><li><a href="#合约分析" class="table-of-contents__link">合约分析</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Solidity</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/rooctblog/docs/solidity/example/Helloworld">HelloWorld</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/rooctblog/">Stack Overflow</a></li></ul></div><div class="col footer__col"><div class="footer__title">Feature</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/rooctblog/">Feature</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/rooctblog/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/rooctblog/">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 dev site, Inc. Built with dev.</div></div></div></footer></div>
<script src="/rooctblog/assets/js/runtime~main.cf7fc36f.js"></script>
<script src="/rooctblog/assets/js/main.998fc8e4.js"></script>
</body>
</html>